manifest {
    mainScript = "main.nf"
    defaultBranch = "master"
    nextflowVersion = ">=20.07.0"
}



params {
    platform_name = ""
    conditions = []
    trials = 3

    output_dir = "trace"
}



trace {
    enabled = true
    fields = "task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt,workdir,scratch,error_action"
    file = "${params.output_dir}/${params.platform_name}.trace.txt"
    raw = true
}



process {
    errorStrategy = "ignore"
}



profiles {
    palmetto {
        params.platform_name = "palmetto"
        params.conditions = [
            [ "node_type": "1a" ],
            [ "node_type": "1b" ],
            [ "node_type": "2a" ],
            [ "node_type": "2b" ],
            [ "node_type": "3" ],
            [ "node_type": "4" ],
            [ "node_type": "5a" ],
            [ "node_type": "5b" ],
            [ "node_type": "5c" ],
            [ "node_type": "5d" ],
            [ "node_type": "6" ],
            [ "node_type": "7a" ],
            [ "node_type": "7b" ],
            [ "node_type": "8a",  "gpu_model": "k20" ],
            [ "node_type": "8b",  "gpu_model": "k20" ],
            [ "node_type": "9",   "gpu_model": "k20" ],
            [ "node_type": "10",  "gpu_model": "k20" ],
            [ "node_type": "11a", "gpu_model": "k40" ],
            [ "node_type": "11b" ],
            [ "node_type": "12",  "gpu_model": "k40" ],
            [ "node_type": "13",  "gpu_model": "k40" ],
            [ "node_type": "14",  "gpu_model": "k40" ],
            [ "node_type": "15",  "gpu_model": "k40" ],
            [ "node_type": "16",  "gpu_model": "p100" ],
            [ "node_type": "17",  "gpu_model": "p100" ],
            [ "node_type": "18b", "gpu_model": "v100" ],
            [ "node_type": "18c", "gpu_model": "v100" ],
            [ "node_type": "19a", "gpu_model": "v100" ],
            [ "node_type": "19b" ],
            [ "node_type": "21",  "gpu_model": "v100" ],
        ]

        process {
            executor = "pbspro"
            time = 1.h

            clusterOptions = {
                c.gpu_model != null
                ? "-l select=1:ncpus=2:mem=6gb:phase=${c.node_type}:ngpus=1:gpu_model=${c.gpu_model}"
                : "-l select=1:ncpus=2:mem=6gb:phase=${c.node_type}"
            }

            module = "cuda/11.0.3-gcc/8.3.1"
        }
        executor {
            queueSize = 50
        }
    }

    standard {
        params.platform_name = "local"
        params.conditions = [
            [ "node_type": "0" ]
        ]

        process {
            executor = "local"
            cpus = 1
            memory = 4.GB
        }
        executor {
            queueSize = 1
        }
    }

    testing {
        process.errorStrategy = "terminate"
    }
}
